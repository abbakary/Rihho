{% extends 'tracker/base.html' %}
{% load static humanize %}

{% block title %}{{ customer.full_name }} - Customer Details{% endblock %}

{% block content %}
<div class="page-body">
  <div class="container-fluid">
    <div class="page-title">
      <div class="row">
        <div class="col-6">
          <h4>{{ customer.full_name }} <small class="text-muted">#{{ customer.code }}</small></h4>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="{% url 'tracker:customers_list' %}">Customers</a></li>
              <li class="breadcrumb-item active">Details</li>
            </ol>
          </nav>
        </div>
        <div class="col-6 text-end">
          <a href="{% url 'tracker:create_order_for_customer' customer.id %}" class="btn btn-primary me-2">
            <i class="fa fa-plus me-2"></i> New Order
          </a>
          <div class="btn-group">
            <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fa fa-cog"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="{% url 'tracker:customer_edit' customer.id %}">
                <i class="fa fa-edit me-2"></i>Edit Customer
              </a></li>
              <li><a class="dropdown-item" href="{% url 'tracker:vehicle_add' customer_id=customer.id %}">
                <i class="fa fa-car me-2"></i>Add Vehicle
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteCustomerModal">
                <i class="fa fa-trash me-2"></i>Delete Customer
              </a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Profile</h5>
            <div class="card-header-right">
              <div class="dropdown">
                <button class="btn btn-light-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa fa-ellipsis-h"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="{% url 'tracker:customer_edit' customer.id %}"><i class="fa fa-edit me-2"></i>Edit</a></li>
                  <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteCustomerModal"><i class="fa fa-trash me-2"></i>Delete</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="text-center mb-4">
              <div class="avatar mx-auto mb-3" style="width: 100px; height: 100px;">
                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center h-100">
                  <span class="text-white fw-bold" style="font-size: 42px;">{{ customer.full_name|slice:":1" }}</span>
                </div>
              </div>
              <h4 class="mb-1">{{ customer.full_name }}</h4>
              <div class="d-flex justify-content-center gap-2 mb-3">
                <span class="badge bg-primary">{{ customer.code }}</span>
                {% if customer.customer_type %}
                <span class="badge bg-info">{{ customer.customer_type|title }}</span>
                {% endif %}
              </div>
            </div>

            <div class="customer-details">
              <div class="card mb-3">
                <div class="card-body">
                  <h6 class="card-title text-uppercase text-muted mb-3">Contact Information</h6>
                  <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                      <i class="fa fa-phone me-2 text-muted"></i>
                      <a href="tel:{{ customer.phone }}" class="text-body">{{ customer.phone }}</a>
                    </div>
                    {% if customer.email %}
                    <div class="d-flex align-items-center">
                      <i class="fa fa-envelope me-2 text-muted"></i>
                      <a href="mailto:{{ customer.email }}" class="text-body">{{ customer.email }}</a>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              {% if customer.organization_name or customer.tax_number %}
              <div class="card mb-3">
                <div class="card-body">
                  <h6 class="card-title text-uppercase text-muted mb-3">Business Information</h6>
                  {% if customer.organization_name %}
                  <div class="mb-2">
                    <span class="text-muted d-block">Organization</span>
                    <span class="fw-medium">{{ customer.organization_name }}</span>
                  </div>
                  {% endif %}
                  {% if customer.tax_number %}
                  <div>
                    <span class="text-muted d-block">Tax Number</span>
                    <span class="fw-medium">{{ customer.tax_number }}</span>
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              <div class="card">
                <div class="card-body">
                  <h6 class="card-title text-uppercase text-muted mb-3">Activity</h6>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Member Since</span>
                    <span class="fw-medium">{{ customer.registration_date|date:'M d, Y' }}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Last Visit</span>
                    <span class="fw-medium">{{ customer.last_visit|date:'M d, Y H:i'|default:'Never' }}</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span class="text-muted">Total Visits</span>
                    <span class="badge bg-primary rounded-pill">{{ customer.total_visits }}</span>
                  </div>
                </div>
              </div>
            </div>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Vehicles</h6>
                <a href="{% url 'tracker:vehicle_add' customer_id=customer.id %}" class="btn btn-sm btn-primary">
                  <i class="fa fa-plus me-1"></i> Add Vehicle
                </a>
              </div>
              <div class="card-body p-0">
                {% if vehicles %}
                  <div class="list-group list-group-flush">
                    {% for vehicle in vehicles %}
                    <div class="list-group-item">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                          <div class="me-3">
                            <div class="bg-light rounded p-2 text-center" style="width: 50px;">
                              <i class="fa fa-car fa-lg text-muted"></i>
                            </div>
                          </div>
                          <div>
                            <h6 class="mb-0">{{ vehicle.make }} {{ vehicle.model }} {% if vehicle.year %}({{ vehicle.year }}){% endif %}</h6>
                            <div class="text-muted small">
                              <span class="me-3">
                                <i class="fa fa-tag me-1"></i> {{ vehicle.plate_number|default:'No plate' }}
                              </span>
                              {% if vehicle.color %}
                              <span>
                                <i class="fa fa-palette me-1"></i> {{ vehicle.get_color_display }}
                              </span>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                        <div class="dropdown">
                          <button class="btn btn-sm btn-light rounded-circle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa fa-ellipsis-v"></i>
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                              <a class="dropdown-item" href="{% url 'tracker:vehicle_edit' vehicle.id %}">
                                <i class="fa fa-edit me-2"></i>Edit
                              </a>
                            </li>
                            <li>
                              <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteVehicleModal{{ vehicle.id }}">
                                <i class="fa fa-trash me-2"></i>Delete
                              </a>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="text-center p-4">
                    <div class="mb-3">
                      <i class="fa fa-car fa-3x text-muted opacity-25"></i>
                    </div>
                    <h6 class="text-muted mb-2">No Vehicles</h6>
                    <p class="text-muted small mb-0">This customer doesn't have any vehicles registered yet.</p>
                    <a href="{% url 'tracker:vehicle_add' customer_id=customer.id %}" class="btn btn-sm btn-primary mt-3">
                      <i class="fa fa-plus me-1"></i> Add First Vehicle
                    </a>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Recent Orders</h5>
                <div class="d-flex">
                  <a class="btn btn-outline-primary btn-sm me-2" href="{% url 'tracker:create_order_for_customer' customer.id %}">
                    <i class="fa fa-plus me-1"></i> New Order
                  </a>
                  <a class="btn btn-sm btn-light" href="{% url 'tracker:orders_list' %}?customer={{ customer.id }}">
                    <i class="fa fa-list me-1"></i> View All
                  </a>
                </div>
              </div>
              <div class="card-body p-0">
                {% if orders %}
                  <div class="list-group list-group-flush">
                    {% for o in orders %}
                    <div class="list-group-item">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                          <div class="me-3">
                            <div class="bg-light rounded p-2 text-center" style="width: 50px;">
                              <i class="fa fa-shopping-cart text-primary"></i>
                            </div>
                          </div>
                          <div>
                            <h6 class="mb-0">
                              <a href="{% url 'tracker:order_detail' o.id %}" class="text-body">
                                {{ o.order_number }}
                              </a>
                            </h6>
                            <div class="d-flex align-items-center flex-wrap gap-2 mt-1">
                              <span class="badge bg-light-primary text-capitalize">
                                <i class="fa fa-tag me-1"></i> {{ o.type|default:'Sale' }}
                              </span>
                              <span class="badge bg-{{ o.status_color|default:'secondary' }} text-capitalize">
                                <i class="fa fa-circle me-1" style="font-size: 8px;"></i> {{ o.status|default:'Draft' }}
                              </span>
                              <span class="text-muted small">
                                <i class="fa fa-clock me-1"></i> {{ o.created_at|timesince }} ago
                              </span>
                            </div>
                          </div>
                        </div>
                        <div class="text-end">
                          <div class="fw-bold mb-1">{{ o.total|default:0|floatformat:2 }} {{ o.currency }}</div>
                          <div class="dropdown d-inline-block">
                            <button class="btn btn-sm btn-light rounded-circle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                              <i class="fa fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                              <li>
                                <a class="dropdown-item" href="{% url 'tracker:order_detail' o.id %}">
                                  <i class="fa fa-eye me-2"></i>View Details
                                </a>
                              </li>
                              <li>
                                <a class="dropdown-item" href="{% url 'tracker:order_edit' o.id %}">
                                  <i class="fa fa-edit me-2"></i>Edit Order
                                </a>
                              </li>
                              <li><hr class="dropdown-divider"></li>
                              <li>
                                <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteOrderModal{{ o.id }}">
                                  <i class="fa fa-trash me-2"></i>Delete
                                </a>
                              </li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  <div class="card-footer bg-transparent border-top-0">
                    <a href="{% url 'tracker:orders_list' %}?customer={{ customer.id }}" class="btn btn-sm btn-link px-0">
                      View all orders <i class="fa fa-arrow-right ms-1"></i>
                    </a>
                  </div>
                {% else %}
                  <div class="text-center p-5">
                    <div class="mb-3">
                      <i class="fa fa-shopping-cart fa-3x text-muted opacity-25"></i>
                    </div>
                    <h6 class="text-muted mb-2">No Orders Yet</h6>
                    <p class="text-muted small mb-4">This customer hasn't placed any orders yet.</p>
                    <a href="{% url 'tracker:create_order_for_customer' customer.id %}" class="btn btn-primary">
                      <i class="fa fa-plus me-1"></i> Create First Order
                    </a>
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Notes Section -->
            <div class="card mt-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Notes & Activity</h5>
                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                  <i class="fa fa-plus me-1"></i> Add Note
                </button>
              </div>
              <div class="card-body">
                {% if customer.notes.all %}
                  <div class="activity-feed">
                    {% for note in customer.notes.all|dictsortreversed:"created_at" %}
                    <div class="activity-item">
                      <div class="activity-avatar">
                        <div class="avatar avatar-sm bg-light-primary rounded-circle">
                          <span class="avatar-content">
                            {{ note.created_by.first_name|slice:":1" }}{{ note.created_by.last_name|slice:":1"|default:note.created_by.username|slice:":1" }}
                          </span>
                        </div>
                      </div>
                      <div class="activity-content">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                          <h6 class="mb-0">{{ note.created_by.get_full_name|default:note.created_by.username }}</h6>
                          <div class="dropdown">
                            <button class="btn btn-xs btn-link text-muted p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                              <i class="fa fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                              <li>
                                <a class="dropdown-item" href="#" data-note-id="{{ note.id }}" onclick="editNote(this)">
                                  <i class="fa fa-edit me-2"></i>Edit
                                </a>
                              </li>
                              <li>
                                <a class="dropdown-item text-danger" href="#" data-note-id="{{ note.id }}" onclick="deleteNote(this)">
                                  <i class="fa fa-trash me-2"></i>Delete
                                </a>
                              </li>
                            </ul>
                          </div>
                        </div>
                        <p class="mb-1 note-content">{{ note.content }}</p>
                        <div class="text-muted small">
                          <i class="fa fa-clock me-1"></i> {{ note.created_at|date:"M j, Y g:i A" }}
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="text-center p-4">
                    <div class="mb-3">
                      <i class="fa fa-sticky-note fa-3x text-muted opacity-25"></i>
                    </div>
                    <h6 class="text-muted mb-2">No Notes Yet</h6>
                    <p class="text-muted small mb-4">Add a note to keep track of important information about this customer.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                      <i class="fa fa-plus me-1"></i> Add Your First Note
                    </button>
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Add Note Modal -->
            <div class="modal fade" id="addNoteModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="noteForm" method="post" action="{% url 'tracker:add_customer_note' customer.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="note_id" id="noteId">
                    <div class="modal-header">
                      <h5 class="modal-title" id="noteModalTitle">Add Note</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="form-group mb-3">
                        <label for="noteContent" class="form-label">Note</label>
                        <textarea class="form-control" id="noteContent" name="note" rows="4" placeholder="Add your note here..." required></textarea>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Save Note</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Customer Modal -->
  <div class="modal fade" id="deleteCustomerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this customer? This action cannot be undone.</p>
          <p class="mb-0"><strong>Customer:</strong> {{ customer.full_name }} ({{ customer.code }})</p>
          {% if orders %}
            <div class="alert alert-warning mt-3 mb-0">
              <i class="fa fa-exclamation-triangle me-2"></i>
              This customer has {{ orders|length }} order{{ orders|pluralize }}. Deleting the customer will also remove all associated orders.
            </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <form method="post" action="{% url 'tracker:customer_delete' pk=customer.id %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Delete Customer</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  {% for o in orders %}
    <!-- Delete Order Modal -->
    <div class="modal fade" id="deleteOrderModal{{ o.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this order? This action cannot be undone.</p>
            <p class="mb-0"><strong>Order #:</strong> {{ o.order_number }}</p>
            <p class="mb-0"><strong>Customer:</strong> {{ o.customer.full_name }}</p>
            <p class="mb-0"><strong>Date:</strong> {{ o.created_at|date:'M d, Y' }}</p>
            <p class="mb-0"><strong>Total:</strong> {{ o.total|default:0|floatformat:2 }} {{ o.currency }}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
            <form method="post" action="{% url 'tracker:order_delete' pk=o.id %}" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}">
              <button type="submit" class="btn btn-danger">Delete Order</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  {% block extra_css %}
  <style>
    /* Activity Feed Styles */
    .activity-feed {
      position: relative;
      padding-left: 1rem;
    }
    
    .activity-item {
      position: relative;
      padding-bottom: 1.5rem;
      padding-left: 2rem;
      border-left: 2px solid #e9ecef;
    }
    
    .activity-item:last-child {
      border-left-color: transparent;
    }
    
    .activity-item:before {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      left: -7px;
      background-color: #fff;
      border: 2px solid #0d6efd;
      border-radius: 50%;
      z-index: 1;
    }
    
    .activity-avatar {
      position: absolute;
      left: -2.5rem;
      top: 0;
    }
    
    .activity-content {
      background: #f8f9fa;
      border-radius: 0.5rem;
      padding: 1rem;
      position: relative;
    }
    
    .activity-content:before {
      content: '';
      position: absolute;
      left: -8px;
      top: 16px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 8px solid #f8f9fa;
    }
    
    .avatar {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: 600;
      color: #fff;
    }
    
    .avatar-sm {
      width: 32px;
      height: 32px;
      font-size: 0.75rem;
    }
    
    /* Custom scrollbar */
    .table-responsive::-webkit-scrollbar {
      height: 6px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
  {% endblock %}
  
  {% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
      
      // Initialize modals
      const noteModal = new bootstrap.Modal(document.getElementById('addNoteModal'));
      
      // Handle modal show/hide events
      const noteForm = document.getElementById('noteForm');
      const noteModalTitle = document.getElementById('noteModalTitle');
      const noteIdField = document.getElementById('noteId');
      const noteContentField = document.getElementById('noteContent');
      
      // Reset form when modal is hidden
      document.getElementById('addNoteModal').addEventListener('hidden.bs.modal', function () {
        noteForm.reset();
        noteForm.action = "{% url 'tracker:add_customer_note' customer.id %}";
        noteModalTitle.textContent = 'Add Note';
        noteIdField.value = '';
      });
      
      // Handle note form submission
      noteForm.addEventListener('submit', function(e) {
        if (!noteContentField.value.trim()) {
          e.preventDefault();
          noteContentField.focus();
          return false;
        }
        return true;
      });
    });
    
    // Edit note function
    function editNote(element) {
      const noteId = element.getAttribute('data-note-id');
      const noteContent = element.closest('.activity-item').querySelector('.note-content').textContent;
      
      document.getElementById('noteId').value = noteId;
      document.getElementById('noteContent').value = noteContent.trim();
      document.getElementById('noteModalTitle').textContent = 'Edit Note';
      document.getElementById('noteForm').action = `{% url 'tracker:add_customer_note' customer.id %}`;
      
      const modal = new bootstrap.Modal(document.getElementById('addNoteModal'));
      modal.show();
    }
    
    // Delete note function
    function deleteNote(element) {
      if (confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
        const noteId = element.getAttribute('data-note-id');
        fetch(`/tracker/customer/{{ customer.id }}/note/${noteId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFTOKEN': '{{ csrf_token }}',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            element.closest('.activity-item').remove();
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.role = 'alert';
            alert.innerHTML = `
              <i class="fa fa-check-circle me-2"></i> Note deleted successfully.
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.card-body').prepend(alert);
            
            // Remove alert after 5 seconds
            setTimeout(() => {
              alert.remove();
            }, 5000);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while deleting the note.');
        });
      }
    }
    
    // Initialize popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl);
    });
  </script>
  {% endblock %}
{% endblock %}
