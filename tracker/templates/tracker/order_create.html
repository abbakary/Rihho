{% extends 'tracker/base.html' %}
{% load static %}

{% block title %}New Order{% endblock %}

{% block content %}
  <div class="container-fluid">
    <div class="page-title">
      <div class="row">
        <div class="col-6"><h4>New Order</h4></div>
        <div class="col-6">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'tracker:orders_list' %}">Orders</a></li>
            <li class="breadcrumb-item active">Create</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="card">
      <div class="card-body">
        <form method="post" novalidate>
          {% csrf_token %}
          {% if customer %}<input type="hidden" name="customer_id" value="{{ customer.id }}">{% endif %}
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">{{ form.type.label }}</label>
              {{ form.type }}
              {% if form.type.errors %}<div class="text-danger f-12">{{ form.type.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ form.priority.label }}</label>
              {{ form.priority }}
              {% if form.priority.errors %}<div class="text-danger f-12">{{ form.priority.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ form.vehicle.label }}</label>
              {{ form.vehicle }}
              {% if form.vehicle.errors %}<div class="text-danger f-12">{{ form.vehicle.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="mt-3" id="section-service" {% if form.initial.type and form.initial.type != 'service' %}style="display:none"{% endif %}>
            <div class="row g-3">
              <div class="col-12">
                <div class="mb-2 f-w-600">Select services</div>
                {{ form.service_selection }}
                {% if form.service_selection.errors %}<div class="text-danger f-12">{{ form.service_selection.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-8">
                <label class="form-label">{{ form.description.label }}</label>
                {{ form.description }}
                {% if form.description.errors %}<div class="text-danger f-12">{{ form.description.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.estimated_duration.label }}</label>
                {{ form.estimated_duration }}
                {% if form.estimated_duration.errors %}<div class="text-danger f-12">{{ form.estimated_duration.errors|striptags }}</div>{% endif %}
              </div>
            </div>
          </div>

          <div class="mt-3" id="section-sales" {% if form.initial.type and form.initial.type != 'sales' %}style="display:none"{% endif %}>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">{{ form.item_name.label }}</label>
                {{ form.item_name }}
                {% if form.item_name.errors %}<div class="text-danger f-12">{{ form.item_name.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.brand.label }}</label>
                {{ form.brand }}
                {% if form.brand.errors %}<div class="text-danger f-12">{{ form.brand.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.quantity.label }}</label>
                {{ form.quantity }}
                {% if form.quantity.errors %}<div class="text-danger f-12">{{ form.quantity.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.tire_type.label }}</label>
                {{ form.tire_type }}
                {% if form.tire_type.errors %}<div class="text-danger f-12">{{ form.tire_type.errors|striptags }}</div>{% endif %}
              </div>
            </div>
          </div>

          <div class="mt-3" id="section-consultation" {% if form.initial.type and form.initial.type != 'consultation' %}style="display:none"{% endif %}>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">{{ form.inquiry_type.label }}</label>
                {{ form.inquiry_type }}
                {% if form.inquiry_type.errors %}<div class="text-danger f-12">{{ form.inquiry_type.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.contact_preference.label }}</label>
                {{ form.contact_preference }}
                {% if form.contact_preference.errors %}<div class="text-danger f-12">{{ form.contact_preference.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.follow_up_date.label }}</label>
                {{ form.follow_up_date }}
                {% if form.follow_up_date.errors %}<div class="text-danger f-12">{{ form.follow_up_date.errors|striptags }}</div>{% endif %}
              </div>
              <div class="col-12">
                <label class="form-label">{{ form.questions.label }}</label>
                {{ form.questions }}
                {% if form.questions.errors %}<div class="text-danger f-12">{{ form.questions.errors|striptags }}</div>{% endif %}
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-4">
            <a class="btn btn-light" href="{% url 'tracker:orders_list' %}">Cancel</a>
            <button class="btn btn-success" type="submit">Create Order</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% block extra_js %}
  <script>
    (function(){
      var typeEl = document.getElementById('{{ form.type.id_for_label }}') || document.querySelector('[name="{{ form.type.html_name }}"]');
      function updateSections(){
        var t = (typeEl && (typeEl.value || typeEl.options && typeEl.options[typeEl.selectedIndex].value)) || '';
        document.getElementById('section-service').style.display = (t==='service')? 'block':'none';
        document.getElementById('section-sales').style.display = (t==='sales')? 'block':'none';
        document.getElementById('section-consultation').style.display = (t==='consultation')? 'block':'none';
      }
      if(typeEl){ typeEl.addEventListener('change', updateSections); updateSections(); }
    })();
  </script>
  {% endblock %}
{% endblock %}
